---
title: "Carbon4d - Sentinel time series"
author: "Edgar Manrique"
format: html
editor: source
---

# Load data

```{r}
#| output: false
  
library(tidyverse)
library(sf)
library(raster)
library(lubridate)
library(rgee)
library(leaflet)
ee_Initialize(user = 'edgar.manrique30@gmail.com')
```

```{r}
img <- ee$Image("users/edgarmanrique30/c4d_s1s2Stack_10m_10D_3857_2021_20220710")

imgVisParams <- list(
    bands = c("NDVI_5", "NDVI_3", "NDVI_1"),
    min = 1000,
    max = 7000,
    opacity = 1
  )
Map$setCenter(11.8687, 50.1059, 12)
Map$addLayer(
  eeObject = img,
  visParams = imgVisParams,
  name = "ndvi stack"
)
```

```{r}
#| output: false
probes <- st_read('ProbeMetaData.geojson')
bodentyp <- raster('OtherLayers/BodentypRasterESC.grd')
bodenart <- raster('OtherLayers/BodenartRasterESC.grd')
landnutzung <- raster('OtherLayers/LandnutzungRasterESC.grd')
esc <- raster('OtherLayers/ESCRasterESC.grd')
```

```{r}
leaflet(probes) |> 
  addProviderTiles('Esri.WorldImagery') |> 
  addCircleMarkers() 
```


```{r}
#| layout: [[50, 50], [50, 50]]
plot(bodentyp, main = 'Bodentyp')
plot(bodenart, main = 'Bodenart')
plot(landnutzung, main = 'Landnutzung')
plot(esc, main = 'Environmental Soil Class')
```



```{r}

source('helpers/aggProbeInSitu.R')

probes_rs2 |> 
  group_by(landnutzung, band, date) |> 
  summarise(value = mean(value, na.rm = T)) |> 
  ggplot() +
  geom_line(aes(x = date, y = value, group = landnutzung, col = landnutzung)) +
  facet_wrap(.~band, scales = 'free_y', ) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', col = 'Landnutzung')
  
```

```{r}
source('load_c4d_data.R')

Probe_Measurements_sf2 <- 
  Probe_Measurements_sf |> 
  dplyr::select(datetime, T_15, M_15, probe_id) |> 
  mutate(datetime = ymd_hms(datetime),
         date = date(datetime),
         doy = yday(date))
```

```{r}
Probe_Measurements_2021_10D_15cm<-
  Probe_Measurements_sf2 |> 
  filter(year(date) == 2021) |> 
  group_by(probe_id, dr = cut(date, breaks = c(range(date), 
            as.Date(c('2021-11-05', 
                    '2021-11-15',
                    '2021-11-25',
                    '2021-12-06',
                    '2021-12-26'))), include.lowest=TRUE)) |> 
  summarise(T_15 = mean(T_15, na.rm = T),
            M_15 = mean(M_15, na.rm = T))
```

```{r}
Probe_Measurements_2021_10D_15cm |> 
ggplot() +
  geom_line(aes(x = ymd(dr), y = T_15, group = probe_id)) + 
  facet_wrap(.~probe_id) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', caption = 'Temperature at 15cm depth')
```



