---
title: "Carbon4d - Sentinel time series"
author: "Edgar Manrique"
format: html
editor: source
---

# Load data

```{r}
#| output: false
  
library(tidyverse)
library(sf)
library(raster)
library(lubridate)
library(rgee)
library(leaflet)
ee_Initialize(user = 'edgar.manrique30@gmail.com')
```

```{r}
img <- ee$Image("users/edgarmanrique30/c4d_s1s2Stack_10m_10D_3857_2021_20220710")

imgVisParams <- list(
    bands = c("NDVI_5", "NDVI_3", "NDVI_1"),
    min = 1000,
    max = 7000,
    opacity = 1
  )
Map$setCenter(11.8687, 50.1059, 12)
Map$addLayer(
  eeObject = img,
  visParams = imgVisParams,
  name = "ndvi stack"
)
```

```{r}
#| output: false
probes <- st_read('layers/ProbeMetaData.geojson')
bodentyp <- raster('layers/BodentypRasterESC.grd')
bodenart <- raster('layers/BodenartRasterESC.grd')
landnutzung <- raster('layers/LandnutzungRasterESC.grd')
esc <- raster('layers/ESCRasterESC.grd')
```

```{r}
leaflet(probes) |> 
  addProviderTiles('Esri.WorldImagery') |> 
  addCircleMarkers() 
```

```{r}
#| layout: [[50, 50], [50, 50]]
plot(bodentyp, main = 'Bodentyp')
plot(bodenart, main = 'Bodenart')
plot(landnutzung, main = 'Landnutzung')
plot(esc, main = 'Environmental Soil Class')
```

```{r}
#| warnings: false

source('helpers/aggProbeInSitu.R')

df2021 <- aggProbeInSitu('2021', '20220710', probes, T_layer = 'T_15', M_layer = 'M_15')
sents2021 <- df2021$probe_sents
sents2021 |> 
  group_by(landnutzung, band, date) |> 
  summarise(value = mean(value, na.rm = T)) |> 
  ggplot() +
  geom_line(aes(x = date, y = value, group = landnutzung, col = landnutzung)) +
  facet_wrap(.~band, scales = 'free_y', ) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', col = 'Landnutzung')
  
```

```{r}
insitu2021 <- df2021$probe_insitu

insitu2021 |> 
ggplot() +
  geom_line(aes(x = date, y = T_15, group = probe_id)) + 
  facet_wrap(.~probe_id) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', caption = 'Temperature at 15cm depth')
```

```{r}
df <- st_read('layers/harmonized.geojson')

df |> 
ggplot() +
  geom_line(aes(x = date, y = T_15, group = probe_id)) + 
  facet_wrap(.~probe_id) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = '', y = '', caption = 'Temperature at 15cm depth')
```



